name: Complete CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: "20"
  BACKEND_DIR: "./Ostad-Capstone-Backend"
  FRONTEND_DIR: "./Ostad-Capstone-Frontend"

jobs:
  # =======================
  # Job 1: Test Backend
  # =======================
  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: ${{ env.BACKEND_DIR }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ env.BACKEND_DIR }}
        run: npm ci

      - name: Run linting
        working-directory: ${{ env.BACKEND_DIR }}
        run: npm run lint || echo "No lint script found"

      - name: Run tests
        working-directory: ${{ env.BACKEND_DIR }}
        run: npm test || echo "No tests found"

  # =======================
  # Job 2: Test Frontend
  # =======================
  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: ${{ env.FRONTEND_DIR }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ env.FRONTEND_DIR }}
        run: npm ci

      - name: Run linting
        working-directory: ${{ env.FRONTEND_DIR }}
        run: npm run lint || echo "No lint script found"

      - name: Run tests
        working-directory: ${{ env.FRONTEND_DIR }}
        run: npm test || echo "No tests found"

  # =======================
  # Job 3: Build Backend
  # =======================
  build-backend:
    name: Build Backend
    needs: test-backend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        working-directory: ${{ env.BACKEND_DIR }}
        run: npm ci

      - name: Build application
        working-directory: ${{ env.BACKEND_DIR }}
        run: npm run build || echo "No build script"

      - name: Create deployment package
        working-directory: ${{ env.BACKEND_DIR }}
        run: |
          mkdir -p deploy
          # cp -r dist/* deploy/ 2>/dev/null || cp -r ./* deploy/
          rsync -av --exclude='deploy' ./ deploy/
          cp package*.json deploy/
          cd deploy && npm ci --production
          tar -czf ../backend-deploy.tar.gz *

      - name: Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-package
          path: ${{ env.BACKEND_DIR }}/backend-deploy.tar.gz
          retention-days: 1

  # =======================
  # Job 4: Build Frontend
  # =======================
  build-frontend:
    name: Build Frontend
    needs: test-frontend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        working-directory: ${{ env.FRONTEND_DIR }}
        run: npm ci

      - name: Build application
        working-directory: ${{ env.FRONTEND_DIR }}
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
        run: npm run build

      - name: Create deployment package
        working-directory: ${{ env.FRONTEND_DIR }}
        run: tar -czf frontend-deploy.tar.gz -C dist .

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-package
          path: ${{ env.FRONTEND_DIR }}/frontend-deploy.tar.gz
          retention-days: 1

  # # =======================
  # # Job 5: Deploy to Server
  # # =======================
  # deploy:
  #   name: Deploy to Production
  #   needs: [build-backend, build-frontend]
  #   runs-on: ubuntu-latest
  #   if: github.ref == 'refs/heads/main' && github.event_name == 'push'

  #   steps:
  #     - name: Download backend package
  #       uses: actions/download-artifact@v3
  #       with:
  #         name: backend-package

  #     - name: Download frontend package
  #       uses: actions/download-artifact@v3
  #       with:
  #         name: frontend-package

  #     - name: Deploy to server
  #       uses: appleboy/ssh-action@master
  #       with:
  #         host: ${{ secrets.SERVER_HOST }}
  #         username: ${{ secrets.SERVER_USER }}
  #         key: ${{ secrets.SSH_PRIVATE_KEY }}
  #         script: |
  #           echo "üöÄ Starting deployment..."

  #           # Create temporary directory
  #           mkdir -p /tmp/deploy

  #           echo "üì¶ Preparing backend deployment..."
  #           # Backend deployment will be handled by SCP

  #           echo "‚úÖ Deployment preparation complete"

  #     - name: Copy backend to server
  #       uses: appleboy/scp-action@master
  #       with:
  #         host: ${{ secrets.SERVER_HOST }}
  #         username: ${{ secrets.SERVER_USER }}
  #         key: ${{ secrets.SSH_PRIVATE_KEY }}
  #         source: "backend-deploy.tar.gz"
  #         target: "/tmp/deploy"

  #     - name: Copy frontend to server
  #       uses: appleboy/scp-action@master
  #       with:
  #         host: ${{ secrets.SERVER_HOST }}
  #         username: ${{ secrets.SERVER_USER }}
  #         key: ${{ secrets.SSH_PRIVATE_KEY }}
  #         source: "frontend-deploy.tar.gz"
  #         target: "/tmp/deploy"

  #     - name: Finalize deployment
  #       uses: appleboy/ssh-action@master
  #       with:
  #         host: ${{ secrets.SERVER_HOST }}
  #         username: ${{ secrets.SERVER_USER }}
  #         key: ${{ secrets.SSH_PRIVATE_KEY }}
  #         script: |
  #           echo "üîÑ Stopping services..."
  #           sudo systemctl stop backend

  #           echo "üìÅ Backing up current version..."
  #           sudo cp -r /var/www/backend /var/www/backend.backup.$(date +%Y%m%d_%H%M%S)
  #           sudo cp -r /var/www/html /var/www/html.backup.$(date +%Y%m%d_%H%M%S)

  #           echo "üóëÔ∏è Cleaning old files..."
  #           sudo rm -rf /var/www/backend/*
  #           sudo rm -rf /var/www/html/*

  #           echo "üì¶ Extracting backend..."
  #           sudo tar -xzf /tmp/deploy/backend-deploy.tar.gz -C /var/www/backend/

  #           echo "üì¶ Extracting frontend..."
  #           sudo tar -xzf /tmp/deploy/frontend-deploy.tar.gz -C /var/www/html/

  #           echo "üîê Setting permissions..."
  #           sudo chown -R www-data:www-data /var/www/backend
  #           sudo chown -R www-data:www-data /var/www/html

  #           echo "üöÄ Starting services..."
  #           sudo systemctl start backend
  #           sudo systemctl reload nginx

  #           echo "üßπ Cleanup..."
  #           rm -rf /tmp/deploy/*

  #           echo "‚úÖ Deployment complete!"

  #           # Verify services
  #           echo "üîç Verifying deployment..."
  #           sudo systemctl status backend --no-pager
  #           curl -f http://localhost:5000/health || echo "‚ö†Ô∏è Backend health check failed"
  #           curl -f http://localhost || echo "‚ö†Ô∏è Frontend check failed"

  #           echo "üéâ All done!"
